<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>2048小游戏</title>
<link rel="stylesheet" href="./lib/bootstrap.min.css">
<style>
.center{text-align: center;}   
.area{width:24rem;height:24rem;box-sizing: border-box;margin:1rem auto;}
.area .col-xs-3{border:1px solid #ddd;height:6rem;width:6rem;box-sizing: border-box;} 
.item{line-height: 6rem;font-size:8rem;color:white;padding:0;}
.control{border:1px solid #ddd;padding:2rem 1rem;}
</style>
</head>
<body class="container">
<div class="row center">
    <h3>2048 小游戏</h3>
</div>

<div class="row center">
    得分：<span class="count">0</span>
</div>
<div class="row center area">
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
    <div class="col-xs-3 item"></div>
</div>

<div class="row center">
    <div class="col-xs-2 col-xs-offset-5 control">上</div>
    <div class="col-xs-2 col-xs-offset-4 control">左</div>
    <div class="col-xs-2 control">右</div>
    <div class="col-xs-2 col-xs-offset-5 control">下</div>
</div>
    
</body>
</html>
<script src="./lib/jquery.js"></script>

<script>

window.onkeydown=function(e){
    if(e.keyCode==37){
        controller.toLeft();
    }else if(e.keyCode==38){
        controller.toUp();
    }else if(e.keyCode==39){
        controller.toRight();
    }else if(e.keyCode==40){
        controller.toDown();
    }
}

$(".control").click(function(){
    var text=$(this).text();
    if(text=="左"){
        controller.toLeft();
    }else if(text=="右"){
        controller.toRight();
    }else if(text=="上"){
        controller.toUp();
    }else if(text=="下"){
        controller.toDown();
    }
})

var controller={
    toLeft:function(isright){
        var i=0;
        var arr=[];
        var row=data.row;
        var maxindex=row-1;
        var old_text=$(".area").text();
        $(".item").each(function(){
          var index=i%row;
          if(index==0){
              arr=[];
          }
          var n=$(this).text();
          if(n){arr.push(n);}
          if(index==maxindex){
              fun.merge(arr,isright);
              fun.arr_pad(arr,row,isright);
              for(var j=0;j<row;j++){
                     $(".item").eq(i-maxindex+j).text(arr[j]);
              }
          }
          i++;
      })
      var is_change=$(".area").text()==old_text?false:true;
      fun.next(is_change);
    },
    toRight:function(){
        this.toLeft(true);
    },
    toUp:function(isright){
        var arr=[];
        var row=data.row;
        var old_text=$(".area").text();
        var i=0;
        $(".item").each(function(){
            var num=$(this).text();
            if(i<row){
                arr[i]=[];
            }
            if(num){
                 arr[i%row].push(num); 
            }
          i++;
        })

        for(var j=0;j<row;j++){
            var tem=arr[j];
            fun.merge(tem,isright);
            fun.arr_pad(tem,row,isright);
            for(var ii=0;ii<row;ii++){
                $(".item").eq(row*ii+j).text(tem[ii]);
            }
        }

      var is_change=$(".area").text()==old_text?false:true;
      fun.next(is_change);
    },
    toDown:function(){
       this.toUp(true);
    }
}

var fun={
    rand:function(min,max){
       return parseInt(Math.random()*(max-min))+min;
    },
    get_color:function(){
       var index=this.rand(0,data.bgcolor.length-1);
       return data.bgcolor[index];
    },
    set_empty:function(){
      data.empty_item=[];
      var i=0;
      $(".item").each(function(){
          var n=$(this).text();
          if(!n){data.empty_item.push(i);}
          i++;
      })
      if(data.empty_item.length==0){
          data.fihish=true;
          alert("游戏结束");
      }
    },
    get_empty:function(){
        var index=this.rand(0,data.empty_item.length-1);
        var item=data.empty_item[index];
        data.empty_item.splice(index,1);
        return item;
    },
    next:function(is_change){
        this.set_bg();
        this.set_empty();
      if(is_change){
        this.set_num();
        // this.set_num();
      }
    },
    set_num:function(){
        var empty=fun.get_empty();
        var style={background:data.bgcolor[0]};
        $(".item").eq(empty).text(2).css(style);
    },
    merge:function(arr,isright){
        if(arr.length<2){return arr;}
        var len=arr.length;
        var old_len=len;
        if(isright){
            for(var i=0;i<len;i++){
                var index=len-1-i;
                if(index-1>=0&&arr[index]==arr[index-1]){
                    arr[index]=2*arr[index];
                    arr.splice(index-1,1);
                    len--;
                    i--;
                }
            }
        }else{
            for(var i=0;i<len;i++){
                if(i+1<len&&arr[i]==arr[i+1]){
                    arr[i]=2*arr[i];
                    arr.splice(i+1,1);
                    len--;
                    i--;
                }
            }
        }
     
        if(arr.length<old_len){
            this.merge(arr);
        }
        return arr;
    },
    copy:function(arr){
        var re=[];
        arr.forEach(function(item){
            re.push(item);
        })
        return re;
    },
    arr_pad:function(arr,len,isright){
       var arr_len=arr.length;
       var empty_len=len-arr_len;
       for(var i=0;i<empty_len;i++){
           if(isright){
               arr.unshift("");
           }else{
               arr.push("");
           }
       }
       return arr;
    },
    set_bg:function(){
        var num=[];
        var count=0;
        $(".item").each(function(){
            var n=$(this).text();
            $(this).css({background:"white"});
            if(n){
                count+=parseInt(n);
                if(num.indexOf(n)==-1){
                    num.push(n);
                }
            }
        })
        num.sort(function(a,b){
            return a-b;
        })
        var color={};
        for(var i=0,len=num.length;i<len;i++){
            color[num[i]]=data.bgcolor[i];
        }
        $(".item").each(function(){
            var n=$(this).text();
            if(n){
                var size=data.fontSize/(n.toString().length)+"rem";
                $(this).css({background:color[n],fontSize:size});
            }else{
                $(this).css({fontSize:data.fontSize+"rem"});
            }
        })
        $(".count").text(count);
    }
}


var data={
    empty_item:[],
    count:0,
    bgcolor:['#ddd',"#999","#FFEFD5","#FFE4B5","#98F5FF","#00F5FF","#9AFF9A","#00FF7F","#00BFFF","#0000FF","#8470FF","#696969","#8B658B","#FFA500","#FF4040","#FF0000"],
    fihish:false,
    row:4,
    fontSize:8,
}


!function(){
    fun.next(true);
}();

var arr=[2,2,2];
// console.log(fun.merge(arr,true));
console.log(fun.arr_pad(arr,10,true));
</script>